<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LeafletJS Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .font-mono { font-family: 'Fira Code', monospace; }
        .leaflet-routing-container { display: none; }
        #map-planner, #map-emergency {
             height: 100vh;
             width: 100%;
             z-index: 10;
        }
        @media (max-width: 768px) {
            #map-planner, #map-emergency { height: 60vh; }
        }
        #analysis-text::after {
            content: '_';
            animation: blink 1s step-end infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }
        .page { display: none; }
        .page.active { display: block; }
        .flex-page.active { display: flex; }
        
        /* Emergency status animations */
        .status-loading {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Emergency result cards */
        .emergency-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .emergency-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">

    <!-- Landing Page -->
    <div id="landing-page" class="page active">
        <div class="min-h-screen bg-gray-900 text-white flex flex-col items-center justify-center p-4">
            <div class="text-center">
                <h1 class="text-4xl md:text-5xl font-bold">Hospital Network & Route Planner</h1>
                <p class="mt-2 text-lg text-gray-400">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</p>
            </div>
            <div class="mt-12 grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl">
                <!-- Planner Mode Button -->
                <div class="bg-gray-800 p-8 rounded-lg border border-gray-700 hover:border-blue-500 transition-all duration-300 transform hover:scale-105">
                    <h2 class="text-2xl font-semibold text-blue-400">‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á (Planner Mode)</h2>
                    <p class="mt-2 text-gray-300">‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢</p>
                    <button id="goto-planner-btn" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏≥‡∏•‡∏≠‡∏á
                    </button>
                </div>
                <!-- Emergency Mode Button -->
                <div class="bg-gray-800 p-8 rounded-lg border border-gray-700 hover:border-green-500 transition-all duration-300 transform hover:scale-105">
                    <h2 class="text-2xl font-semibold text-green-400">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (Emergency Mode)</h2>
                    <p class="mt-2 text-gray-300">‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</p>
                     <button id="goto-emergency-btn" class="mt-6 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô
                    </button>
                </div>
            </div>
             <footer class="text-center text-xs text-gray-500 pt-12 mt-8">
                <p>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô: "‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢"</p>
             </footer>
        </div>
    </div>

    <!-- Planner Page -->
    <div id="planner-page" class="flex-page page flex-col md:flex-row h-screen overflow-hidden">
        <aside class="w-full md:w-96 bg-white p-4 shadow-lg overflow-y-auto z-20 flex flex-col">
            <div class="flex-grow">
                 <button id="back-to-landing-1" class="mb-4 text-sm text-blue-600 hover:underline">&lt; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                <header class="pb-4 border-b mb-4">
                    <h1 class="text-2xl font-bold text-gray-800">‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</h1>
                    <p class="text-sm text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</p>
                </header>
                <!-- Controls for Planner -->
                <section class="mb-4">
                    <h2 class="text-lg font-semibold text-gray-700 mb-2">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</h2>
                    <label for="province-filter" class="text-sm font-medium text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</label>
                    <select id="province-filter" class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5">
                        <option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    </select>
                </section>
                <section>
                    <h2 class="text-lg font-semibold text-gray-700 mb-2">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</h2>
                    <div class="space-y-3">
                        <div>
                            <label for="start-hospital" class="text-sm">‡∏à‡∏≤‡∏Å (‡∏£‡∏û. ‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á):</label>
                            <select id="start-hospital" class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5" disabled>
                                <option>‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏£‡∏û. ‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á</option>
                            </select>
                        </div>
                        <div>
                            <label for="end-hospital" class="text-sm">‡∏ñ‡∏∂‡∏á (‡∏£‡∏û. ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á):</label>
                            <select id="end-hospital" class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5" disabled>
                                 <option>‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏£‡∏û. ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</option>
                            </select>
                        </div>
                    </div>
                    <button id="calculate-route-btn" class="mt-4 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg" disabled>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</button>
                    <button id="reset-btn" class="mt-2 w-full bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                </section>
                <section id="results-panel" class="mt-6 pt-4 border-t hidden">
                    <h2 class="text-lg font-semibold">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h2>
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg mt-2">
                        <p><strong>‡∏à‡∏≤‡∏Å:</strong> <span id="result-from"></span></p>
                        <p><strong>‡∏ñ‡∏∂‡∏á:</strong> <span id="result-to"></span></p>
                        <div class="pt-2 mt-2 border-t">
                             <p class="text-xl font-bold">‡πÄ‡∏ß‡∏•‡∏≤: <span id="result-time" class="text-blue-600"></span></p>
                             <p>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: <span id="result-distance" class="text-blue-600"></span></p>
                        </div>
                    </div>
                    <div id="intermediate-hospitals-section" class="mt-4 hidden">
                        <h3 class="font-semibold text-gray-700">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô:</h3>
                        <div id="intermediate-list" class="text-sm mt-2 space-y-2">
                            <!-- Intermediate hospitals will be injected here -->
                        </div>
                    </div>
                </section>
                 <section class="mt-6 pt-4 border-t">
                     <h2 class="text-lg font-semibold">‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h2>
                     <button id="toggle-analysis-btn" class="mt-2 w-full bg-gray-800 text-white font-bold py-2 px-4 rounded-lg">&gt; ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
                     <div id="analysis-panel" class="hidden mt-2 p-3 bg-black text-green-400 rounded-lg font-mono text-sm">
                        <p class="text-xs">[‡∏£‡∏∞‡∏ö‡∏ö: ‡πÅ‡∏Å‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡∏Ñ‡πå‡∏™‡∏ï‡∏£‡∏≤]</p>
                        <div id="analysis-text-container" class="mt-2 whitespace-pre-wrap h-64 overflow-y-auto"><p id="analysis-text"></p></div>
                     </div>
                </section>
            </div>
        </aside>
        <main class="flex-1"><div id="map-planner"></div></main>
    </div>

    <!-- Emergency Page -->
    <div id="emergency-page" class="flex-page page flex-col md:flex-row h-screen overflow-hidden">
         <aside class="w-full md:w-96 bg-white p-4 shadow-lg overflow-y-auto z-20 flex flex-col">
            <div class="flex-grow">
                 <button id="back-to-landing-2" class="mb-4 text-sm text-blue-600 hover:underline">&lt; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                <header class="pb-4 border-b mb-4">
                    <h1 class="text-2xl font-bold text-red-600">‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h1>
                    <p class="text-sm text-gray-500">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
                </header>
                <section>
                    <div class="space-y-3">
                         <div>
                            <label for="emergency-case" class="text-sm font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô:</label>
                            <select id="emergency-case" class="mt-1 block w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5">
                                <option value="general">‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                                <option value="stroke">‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á (Stroke)</option>
                                <option value="heart">‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à</option>
                                <option value="er-icu">‡∏´‡πâ‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô/‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏≠‡∏ã‡∏µ‡∏¢‡∏π (ER/ICU)</option>
                                <option value="trauma">‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á/‡πÄ‡∏ó‡∏£‡∏≤‡∏°‡∏≤</option>
                            </select>
                        </div>
                        <button id="find-location-btn" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition flex items-center justify-center space-x-2">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                             <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</span>
                        </button>
                        <button id="test-location-btn" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</button>
                        <button id="reset-emergency-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                        <p id="emergency-status" class="text-center text-sm text-gray-500 h-10 flex items-center justify-center"></p>
                        
                        <!-- Help section -->
                        <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-xs">
                            <p class="font-semibold text-yellow-800 mb-1">üí° ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ:</p>
                            <ul class="text-yellow-700 space-y-1 ml-4">
                                <li>‚Ä¢ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô Browser</li>
                                <li>‚Ä¢ ‡πÄ‡∏õ‡∏¥‡∏î Location Services ‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</li>
                                <li>‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ GPS</li>
                                <li>‚Ä¢ ‡πÉ‡∏ä‡πâ HTTPS ‡πÅ‡∏ó‡∏ô HTTP</li>
                            </ul>
                        </div>
                    </div>
                </section>
                 <section id="emergency-results-panel" class="mt-6 pt-4 border-t hidden">
                    <h2 class="text-lg font-semibold text-gray-700 mb-2">‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h2>
                    <div id="emergency-results-content" class="space-y-3">
                        <!-- Route details will be injected here -->
                    </div>
                    <div id="emergency-intermediate-section" class="mt-4 hidden">
                        <h3 class="font-semibold text-gray-700">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô:</h3>
                        <ul id="emergency-intermediate-list" class="text-sm mt-2 space-y-2">
                            <!-- Intermediate hospitals will be injected here -->
                        </ul>
                    </div>
                </section>
            </div>
        </aside>
        <main class="flex-1"><div id="map-emergency"></div></main>
    </div>

    <script>
        // --- DATA INITIALIZATION ---
        const hospitalData = [
            { "Province": "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏£‡∏µ‡∏™‡∏±‡∏á‡∏ß‡∏≤‡∏•‡∏¢‡πå", "Hospital_EN": "Srisangwan Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ/‡∏®‡∏π‡∏ô‡∏¢‡πå", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "Latitude": 19.298897, "Longitude": 97.97137, "Specialty": "" },
            { "Province": "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏õ‡∏≤‡∏¢", "Hospital_EN": "Pai Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ä‡∏∏‡∏°‡∏ä‡∏ô (‡∏´‡∏•‡∏±‡∏Å)", "District": "‡∏õ‡∏≤‡∏¢", "Latitude": 19.3619, "Longitude": 98.43785, "Specialty": "" },
            { "Province": "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÅ‡∏°‡πà‡∏™‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á", "Hospital_EN": "Mae Sariang Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ä‡∏∏‡∏°‡∏ä‡∏ô (‡∏´‡∏•‡∏±‡∏Å)", "District": "‡πÅ‡∏°‡πà‡∏™‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á", "Latitude": 18.16239, "Longitude": 97.93987, "Specialty": "" },
            { "Province": "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏Ç‡∏∏‡∏ô‡∏¢‡∏ß‡∏°", "Hospital_EN": "Khun Yuam Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ä‡∏∏‡∏°‡∏ä‡∏ô (‡∏´‡∏•‡∏±‡∏Å)", "District": "‡∏Ç‡∏∏‡∏ô‡∏¢‡∏ß‡∏°", "Latitude": 18.830595, "Longitude": 97.936262, "Specialty": "" },
            { "Province": "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÅ‡∏°‡πà‡∏•‡∏≤‡∏ô‡πâ‡∏≠‡∏¢", "Hospital_EN": "Mae La Noi Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ä‡∏∏‡∏°‡∏ä‡∏ô (‡∏´‡∏•‡∏±‡∏Å)", "District": "‡πÅ‡∏°‡πà‡∏•‡∏≤‡∏ô‡πâ‡∏≠‡∏¢", "Latitude": 18.37993686, "Longitude": 97.94303051, "Specialty": "" },
            { "Province": "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏õ‡∏≤‡∏á‡∏°‡∏∞‡∏ú‡πâ‡∏≤", "Hospital_EN": "Pang Mapha Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ä‡∏∏‡∏°‡∏ä‡∏ô (‡∏´‡∏•‡∏±‡∏Å)", "District": "‡∏õ‡∏≤‡∏á‡∏°‡∏∞‡∏ú‡πâ‡∏≤", "Latitude": 19.52418, "Longitude": 98.24267, "Specialty": "" },
            { "Province": "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏ö‡πÄ‡∏°‡∏¢", "Hospital_EN": "Sop Moei Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ä‡∏∏‡∏°‡∏ä‡∏ô (‡∏´‡∏•‡∏±‡∏Å)", "District": "‡∏™‡∏ö‡πÄ‡∏°‡∏¢", "Latitude": 17.96412, "Longitude": 97.93135, "Specialty": "" },
            { "Province": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä‡∏ô‡∏Ñ‡∏£‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏™‡∏ß‡∏ô‡∏î‡∏≠‡∏Å)", "Hospital_EN": "Maharaj Nakorn Chiang Mai Hospital (Suan Dok)", "Type": "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Latitude": 18.789598, "Longitude": 98.974269, "Specialty": "‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á ‡∏™‡∏ß‡∏ô‡∏î‡∏≠‡∏Å ‡∏°‡∏ä" },
            { "Province": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Hospital_TH": "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏®‡∏£‡∏µ‡∏û‡∏±‡∏í‡∏ô‡πå ‡∏Ñ‡∏ì‡∏∞‡πÅ‡∏û‡∏ó‡∏¢‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏°‡∏ä.", "Hospital_EN": "Sriphat Medical Center (CMU)", "Type": "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Latitude": 18.78938, "Longitude": 98.97748, "Specialty": "‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à ‡∏®‡∏£‡∏µ‡∏û‡∏±‡∏í‡∏ô‡πå ‡∏™‡∏ß‡∏ô‡∏î‡∏≠‡∏Å" },
            { "Province": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ô‡∏Ñ‡∏£‡∏û‡∏¥‡∏á‡∏Ñ‡πå", "Hospital_EN": "Nakornping Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ/‡∏®‡∏π‡∏ô‡∏¢‡πå", "District": "‡πÅ‡∏°‡πà‡∏£‡∏¥‡∏°", "Latitude": 18.85138, "Longitude": 98.96813, "Specialty": "‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡πÉ‡∏à" },
            { "Province": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏£‡∏≤‡∏°", "Hospital_EN": "Chiang Mai Ram Hospital", "Type": "‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Latitude": 18.794884, "Longitude": 98.977826, "Specialty": "‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à/‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î" },
            { "Province": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Hospital_EN": "Bangkok Hospital Chiang Mai", "Type": "‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Latitude": 18.786686, "Longitude": 99.026436, "Specialty": "‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à/‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î" },
            { "Province": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÅ‡∏°‡∏Ñ‡∏Ñ‡∏≠‡∏£‡πå‡∏°‡∏¥‡∏Ñ", "Hospital_EN": "McCormick Hospital", "Type": "‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Latitude": 18.798017, "Longitude": 99.010259, "Specialty": "ER/ICU ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ" },
            { "Province": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏£‡∏≤‡∏ä‡πÄ‡∏ß‡∏ä ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Hospital_EN": "Rajavej Chiang Mai Hospital", "Type": "‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Latitude": 18.766808, "Longitude": 99.004369, "Specialty": "ER/‡∏´‡∏±‡∏ß‡πÉ‡∏à" },
            { "Province": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏•‡πâ‡∏≤‡∏ô‡∏ô‡∏≤", "Hospital_EN": "Lanna Hospital", "Type": "‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Latitude": 18.812271, "Longitude": 98.991086, "Specialty": "ER/ICU" },
            { "Province": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏ó‡∏û‡∏õ‡∏±‡∏ç‡∏ç‡∏≤", "Hospital_EN": "Theppanya Hospital", "Type": "‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Latitude": 18.810143, "Longitude": 99.01135, "Specialty": "ER/ICU" },
            { "Province": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏à‡∏≠‡∏°‡∏ó‡∏≠‡∏á", "Hospital_EN": "Chom Thong Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ä‡∏∏‡∏°‡∏ä‡∏ô (‡∏´‡∏•‡∏±‡∏Å)", "District": "‡∏à‡∏≠‡∏°‡∏ó‡∏≠‡∏á", "Latitude": 18.42065, "Longitude": 98.6756, "Specialty": "" },
            { "Province": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ù‡∏≤‡∏á", "Hospital_EN": "Fang Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ä‡∏∏‡∏°‡∏ä‡∏ô (‡∏´‡∏•‡∏±‡∏Å)", "District": "‡∏ù‡∏≤‡∏á", "Latitude": 19.92212, "Longitude": 99.21332, "Specialty": "" },
            { "Province": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏±‡∏ô‡∏Å‡∏≥‡πÅ‡∏û‡∏á", "Hospital_EN": "San Kamphaeng Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ä‡∏∏‡∏°‡∏ä‡∏ô (‡∏´‡∏•‡∏±‡∏Å)", "District": "‡∏™‡∏±‡∏ô‡∏Å‡∏≥‡πÅ‡∏û‡∏á", "Latitude": 18.74719, "Longitude": 99.13032, "Specialty": "" },
            { "Province": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢", "Hospital_EN": "San Sai Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ä‡∏∏‡∏°‡∏ä‡∏ô (‡∏´‡∏•‡∏±‡∏Å)", "District": "‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢", "Latitude": 18.87763, "Longitude": 99.05284, "Specialty": "" },
            { "Province": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ô‡∏∏‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", "Hospital_EN": "Chiangrai Prachanukroh Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ/‡∏®‡∏π‡∏ô‡∏¢‡πå", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "Latitude": 19.91428, "Longitude": 99.84157, "Specialty": "‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡πÉ‡∏à" },
            { "Province": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏Å‡∏©‡∏°‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå ‡∏®‡∏£‡∏µ‡∏ö‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", "Hospital_EN": "Kasemrad Sriburin General Hospital", "Type": "‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "Latitude": 19.92341, "Longitude": 99.82902, "Specialty": "‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à" },
            { "Province": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÇ‡∏≠‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ö‡∏£‡∏π‡πä‡∏Ñ", "Hospital_EN": "Overbrook Hospital", "Type": "‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "Latitude": 19.91139, "Longitude": 99.83278, "Specialty": "" },
            { "Province": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ç‡∏≤‡∏ì‡∏™‡∏±‡∏á‡∏ß‡∏£", "Hospital_EN": "Somdejphrayanasangworn Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ä‡∏∏‡∏°‡∏ä‡∏ô (‡∏´‡∏•‡∏±‡∏Å)", "District": "‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏ä‡∏±‡∏¢", "Latitude": 19.86533, "Longitude": 99.96766, "Specialty": "" },
            { "Province": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÅ‡∏°‡πà‡∏™‡∏≤‡∏¢", "Hospital_EN": "Mae Sai Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ä‡∏∏‡∏°‡∏ä‡∏ô (‡∏´‡∏•‡∏±‡∏Å)", "District": "‡πÅ‡∏°‡πà‡∏™‡∏≤‡∏¢", "Latitude": 20.43075, "Longitude": 99.88562, "Specialty": "" },
            { "Province": "‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "Hospital_EN": "Phayao Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ/‡∏®‡∏π‡∏ô‡∏¢‡πå", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "Latitude": 19.1802, "Longitude": 99.8821, "Specialty": "‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡πÉ‡∏à" },
            { "Province": "‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥", "Hospital_EN": "Chiangkham Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ä‡∏∏‡∏°‡∏ä‡∏ô (‡∏´‡∏•‡∏±‡∏Å)", "District": "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥", "Latitude": 19.5317, "Longitude": 100.297, "Specialty": "" },
            { "Province": "‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "Hospital_EN": "University of Phayao Medical Center and Hospital", "Type": "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "Latitude": 19.03056, "Longitude": 99.91833, "Specialty": "‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à" },
            { "Province": "‡∏ô‡πà‡∏≤‡∏ô", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ô‡πà‡∏≤‡∏ô", "Hospital_EN": "Nan Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ/‡∏®‡∏π‡∏ô‡∏¢‡πå", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡πà‡∏≤‡∏ô", "Latitude": 18.7731, "Longitude": 100.767, "Specialty": "‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡πÉ‡∏à" },
            { "Province": "‡∏•‡∏≥‡∏õ‡∏≤‡∏á", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏•‡∏≥‡∏õ‡∏≤‡∏á", "Hospital_EN": "Lampang Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ/‡∏®‡∏π‡∏ô‡∏¢‡πå", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏•‡∏≥‡∏õ‡∏≤‡∏á", "Latitude": 18.2831, "Longitude": 99.4893, "Specialty": "‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡πÉ‡∏à" },
            { "Province": "‡∏•‡∏≥‡∏õ‡∏≤‡∏á", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏Ñ‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏£‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏°‡∏ô‡∏ï‡∏£‡∏µ", "Hospital_EN": "Fort Surasakmontri Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ/‡∏®‡∏π‡∏ô‡∏¢‡πå", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏•‡∏≥‡∏õ‡∏≤‡∏á", "Latitude": 18.29139, "Longitude": 99.51333, "Specialty": "" },
            { "Province": "‡∏•‡∏≥‡∏û‡∏π‡∏ô", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏•‡∏≥‡∏û‡∏π‡∏ô", "Hospital_EN": "Lamphun Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ/‡∏®‡∏π‡∏ô‡∏¢‡πå", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏•‡∏≥‡∏û‡∏π‡∏ô", "Latitude": 18.5802, "Longitude": 99.0061, "Specialty": "‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡πÉ‡∏à" },
            { "Province": "‡πÅ‡∏û‡∏£‡πà", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÅ‡∏û‡∏£‡πà", "Hospital_EN": "Phrae Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ/‡∏®‡∏π‡∏ô‡∏¢‡πå", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏û‡∏£‡πà", "Latitude": 18.14083, "Longitude": 100.14028, "Specialty": "‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡πÉ‡∏à" },
            { "Province": "‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå", "Hospital_TH": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå", "Hospital_EN": "Uttaradit Hospital", "Type": "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ/‡∏®‡∏π‡∏ô‡∏¢‡πå", "District": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå", "Latitude": 17.625, "Longitude": 100.09556, "Specialty": "‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡πÉ‡∏à" }
        ];
        
        document.addEventListener('DOMContentLoaded', () => {
            
            function formatTime(minutes) {
                if (isNaN(minutes) || minutes < 0) return 'N/A';
                const totalMins = Math.round(minutes);
                if (totalMins < 60) {
                    return `${totalMins} ‡∏ô‡∏≤‡∏ó‡∏µ`;
                }
                const hours = Math.floor(totalMins / 60);
                const remainingMinutes = totalMins % 60;
                return `${totalMins} ‡∏ô‡∏≤‡∏ó‡∏µ (${hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${remainingMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ)`;
            }

            const pages = document.querySelectorAll('.page');
            const landingPage = document.getElementById('landing-page');
            const plannerPage = document.getElementById('planner-page');
            const emergencyPage = document.getElementById('emergency-page');

            document.getElementById('goto-planner-btn').addEventListener('click', () => switchPage(plannerPage));
            document.getElementById('goto-emergency-btn').addEventListener('click', () => switchPage(emergencyPage));
            document.getElementById('back-to-landing-1').addEventListener('click', () => switchPage(landingPage));
            document.getElementById('back-to-landing-2').addEventListener('click', () => switchPage(landingPage));

            function switchPage(targetPage) {
                pages.forEach(page => {
                    page.classList.remove('active', 'flex-page');
                });
                targetPage.classList.add('active');
                 if(targetPage.id === 'planner-page' || targetPage.id === 'emergency-page') {
                    targetPage.classList.add('flex-page');
                 }
                
                 if (targetPage.id === 'planner-page') {
                     initPlannerApp();
                 }
                 if (targetPage.id === 'emergency-page') {
                     initEmergencyApp();
                 }

                 setTimeout(() => {
                    if (plannerMap) plannerMap.invalidateSize();
                    if (emergencyMap) emergencyMap.invalidateSize();
                }, 100);
            }
            
            const plannerMapEl = document.getElementById('map-planner');
            const provinceFilter = document.getElementById('province-filter');
            const startHospitalSelect = document.getElementById('start-hospital');
            const endHospitalSelect = document.getElementById('end-hospital');
            const calculateBtn = document.getElementById('calculate-route-btn');
            const resetBtn = document.getElementById('reset-btn');
            const resultsPanel = document.getElementById('results-panel');
            const toggleAnalysisBtn = document.getElementById('toggle-analysis-btn');
            const analysisPanel = document.getElementById('analysis-panel');
            const analysisTextEl = document.getElementById('analysis-text');
            const intermediateSection = document.getElementById('intermediate-hospitals-section');
            const intermediateList = document.getElementById('intermediate-list');
            
            let plannerMap, plannerMarkersLayer, plannerRoutingControl, typingInterval;
            let currentAnalysisText = '';
            let isPlannerInitialized = false;
            
            function initPlannerApp() {
                if (isPlannerInitialized) return;

                plannerMap = L.map(plannerMapEl);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(plannerMap);
                plannerMarkersLayer = L.layerGroup().addTo(plannerMap);
                
                populateProvinceFilter();
                provinceFilter.value = 'all';
                filterAndDisplayHospitals();

                provinceFilter.addEventListener('change', () => {
                    if (plannerRoutingControl) plannerMap.removeControl(plannerRoutingControl);
                    resultsPanel.classList.add('hidden');
                    filterAndDisplayHospitals();
                });
                startHospitalSelect.addEventListener('change', validateSelections);
                endHospitalSelect.addEventListener('change', validateSelections);
                calculateBtn.addEventListener('click', calculatePlannerRoute);
                resetBtn.addEventListener('click', resetPlanner);
                toggleAnalysisBtn.addEventListener('click', toggleAnalysisPanel);

                isPlannerInitialized = true;
            }

            function populateProvinceFilter() {
                const provinces = [...new Set(hospitalData.map(h => h.Province))].sort();
                provinces.forEach(p => provinceFilter.add(new Option(p, p)));
            }

            function filterAndDisplayHospitals() {
                const selected = provinceFilter.value;
                const filtered = selected === 'all' ? hospitalData : hospitalData.filter(h => h.Province === selected);
                renderPlannerMarkers(filtered);
                populateHospitalSelectors(filtered);
                if (filtered.length) {
                    const bounds = L.latLngBounds(filtered.map(h => [h.Latitude, h.Longitude]));
                    if (bounds.isValid()) {
                         plannerMap.fitBounds(bounds, {padding: [50, 50]});
                    }
                }
            }

            function renderPlannerMarkers(hospitals) {
                plannerMarkersLayer.clearLayers();
                hospitals.forEach(h => {
                    L.marker([h.Latitude, h.Longitude]).addTo(plannerMarkersLayer)
                        .bindPopup(`<strong>${h.Hospital_TH}</strong><br>${h.Type}`);
                });
            }

            function populateHospitalSelectors(hospitals) {
                startHospitalSelect.innerHTML = '<option value="">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>';
                endHospitalSelect.innerHTML = '<option value="">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>';
                hospitals.forEach((h, i) => {
                    const optionText = `${h.Hospital_TH} (${h.District})`;
                    startHospitalSelect.add(new Option(optionText, i));
                    endHospitalSelect.add(new Option(optionText, i));
                });
                startHospitalSelect.disabled = endHospitalSelect.disabled = hospitals.length === 0;
            }

            function validateSelections() {
                calculateBtn.disabled = !(startHospitalSelect.value && endHospitalSelect.value && startHospitalSelect.value !== endHospitalSelect.value);
            }

            function getRouteTime(startLatLng, endLatLng) {
                return new Promise((resolve, reject) => {
                    const tempRouter = L.Routing.control({
                        waypoints: [startLatLng, endLatLng],
                        createMarker: () => null,
                        routeWhileDragging: false,
                        addWaypoints: false,
                        draggableWaypoints: false,
                        fitSelectedRoutes: false,
                        show: false
                    });

                    const onRouteFound = (e) => {
                        const time = e.routes[0].summary.totalTime / 60;
                        plannerMap.removeControl(tempRouter);
                        resolve(time);
                    };

                    const onRouteError = (e) => {
                        console.error("Intermediate route error:", e);
                        plannerMap.removeControl(tempRouter);
                        reject(e.error);
                    };
                    
                    tempRouter.on('routesfound', onRouteFound);
                    tempRouter.on('routingerror', onRouteError);
                    tempRouter.addTo(plannerMap);
                });
            }

            async function findIntermediateHospitals(startH, endH, mainRoute) {
                intermediateSection.classList.remove('hidden');
                intermediateList.innerHTML = '<li>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</li>';

                const routeCoordinates = mainRoute.coordinates;
                const otherHospitals = hospitalData.filter(h => h.Hospital_TH !== startH.Hospital_TH && h.Hospital_TH !== endH.Hospital_TH);
                
                const candidates = otherHospitals.filter(hospital => {
                    const hospitalLatLng = L.latLng(hospital.Latitude, hospital.Longitude);
                    for (let i = 0; i < routeCoordinates.length; i += 5) { // Check every 5th coord for performance
                        if (hospitalLatLng.distanceTo(routeCoordinates[i]) < 10000) { // 10km threshold
                            return true;
                        }
                    }
                    return false;
                });

                if (candidates.length === 0) {
                    intermediateList.innerHTML = '<li>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ö‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</li>';
                    return;
                }
                
                const startLatLng = L.latLng(startH.Latitude, startH.Longitude);
                const results = [];

                // Process candidates sequentially to avoid overwhelming the routing service
                for (const candidate of candidates) {
                    try {
                        const candidateLatLng = L.latLng(candidate.Latitude, candidate.Longitude);
                        const time = await getRouteTime(startLatLng, candidateLatLng);
                        results.push({ name: candidate.Hospital_TH, time: time });
                    } catch (error) {
                        console.warn(`Could not calculate route for ${candidate.Hospital_TH}:`, error);
                    }
                }
                
                if (results.length === 0) {
                    intermediateList.innerHTML = '<li>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ</li>';
                    return;
                }

                results.sort((a, b) => a.time - b.time);

                intermediateList.innerHTML = results.map(r => 
                    `<li class="border-b pb-1"><strong>${r.name}</strong><br><span class="text-gray-600">~ ${formatTime(r.time)} ‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span></li>`
                ).join('');
            }


            function calculatePlannerRoute() {
                if (plannerRoutingControl) plannerMap.removeControl(plannerRoutingControl);
                
                const selected = provinceFilter.value;
                const list = selected === 'all' ? hospitalData : hospitalData.filter(h => h.Province === selected);
                const startH = list[startHospitalSelect.value];
                const endH = list[endHospitalSelect.value];
                
                const startLatLng = L.latLng(startH.Latitude, startH.Longitude);
                const endLatLng = L.latLng(endH.Latitude, endH.Longitude);

                plannerRoutingControl = L.Routing.control({ waypoints: [startLatLng, endLatLng]}).addTo(plannerMap);
                
                plannerRoutingControl.on('routesfound', e => {
                    const route = e.routes[0];
                    const summary = route.summary;
                    const totalMinutes = summary.totalTime / 60;
                    const distanceKm = (summary.totalDistance / 1000).toFixed(2);
                    
                    const bounds = L.latLngBounds(startLatLng, endLatLng);
                    plannerMap.fitBounds(bounds, { padding: [50, 50] });

                    document.getElementById('result-from').textContent = startH.Hospital_TH;
                    document.getElementById('result-to').textContent = endH.Hospital_TH;
                    document.getElementById('result-time').textContent = formatTime(totalMinutes);
                    document.getElementById('result-distance').textContent = `${distanceKm} ‡∏Å‡∏°.`;
                    resultsPanel.classList.remove('hidden');
                    
                    findIntermediateHospitals(startH, endH, route);

                    currentAnalysisText = `[‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á]\n\n` +
                        `-- 1. ‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏≤‡∏ü --\n` +
                        `> ‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢ ‡∏£‡∏û. ‡∏ñ‡∏π‡∏Å‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏≤‡∏ü G(V, E) ‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡πà:\n` +
                        `>  V (Vertices): ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ã‡∏ï‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• (‡πÇ‡∏´‡∏ô‡∏î)\n` +
                        `>  E (Edges): ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ã‡∏ï‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á (‡∏ñ‡∏ô‡∏ô)\n` +
                        `>  Weight (w): ‡∏Ñ‡∏∑‡∏≠ '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á' (‡∏ô‡∏≤‡∏ó‡∏µ)\n\n` +
                        `> ‡πÇ‡∏´‡∏ô‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (A): ${startH.Hospital_TH}\n` +
                        `> ‡πÇ‡∏´‡∏ô‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (B): ${endH.Hospital_TH}\n\n` +
                        `-- 2. ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡πâ‡∏ß‡∏¢ Dijkstra's Algorithm --\n` +
                        `‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î d(v) ‡∏à‡∏≤‡∏Å A ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏ô‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ (v)\n\n` +
                        `‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏≤‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå:\n` +
                        `1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Initialization):\n` +
                        `   - ‡∏Å‡∏≥‡∏´‡∏ô‡∏î d(A) = 0\n` +
                        `   - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏ô‡∏î v ‡∏≠‡∏∑‡πà‡∏ô‡πÜ, ‡∏Å‡∏≥‡∏´‡∏ô‡∏î d(v) = ‚àû\n` +
                        `   - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ã‡∏ï S ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏ô‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏°\n\n` +
                        `2. ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ã‡πâ‡∏≥ (Iteration):\n` +
                        `   - ‡∏ï‡∏£‡∏≤‡∏ö‡πÉ‡∏î‡∏ó‡∏µ‡πà S ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á:\n` +
                        `   a. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏ô‡∏î u ‡∏à‡∏≤‡∏Å S ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ d(u) ‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î\n` +
                        `   b. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏ô‡∏î‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á v ‡∏Ç‡∏≠‡∏á u:\n` +
                        `      ‡∏ñ‡πâ‡πà‡∏≤ d(u) + w(u, v) < d(v) \n` +
                        `      ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡πà‡∏≤: d(v) = d(u) + w(u, v)\n` +
                        `   c. ‡∏ô‡∏≥ u ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å S\n\n` +
                        `-- 3. ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå --\n` +
                        `> ‡∏≠‡∏±‡∏•‡∏Å‡∏≠‡∏£‡∏¥‡∏ó‡∏∂‡∏°‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå d(B) ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î\n` +
                        `> ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤: ${formatTime(totalMinutes)}\n` +
                        `[‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô]`;
                });
            }

            function resetPlanner() {
                provinceFilter.value = 'all';
                filterAndDisplayHospitals();
                if (plannerRoutingControl) plannerMap.removeControl(plannerRoutingControl);
                resultsPanel.classList.add('hidden');
                intermediateSection.classList.add('hidden');
                intermediateList.innerHTML = '';
                startHospitalSelect.value = "";
                endHospitalSelect.value = "";
                validateSelections();
                currentAnalysisText = '';
                analysisPanel.classList.add('hidden');
                toggleAnalysisBtn.innerHTML = `&gt; ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå`;
            }

            function toggleAnalysisPanel() {
                const isHidden = analysisPanel.classList.toggle('hidden');
                if (typingInterval) clearInterval(typingInterval);

                if (!isHidden) {
                    toggleAnalysisBtn.innerHTML = `&gt; ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå`;
                    const content = currentAnalysisText || '‡πÇ‡∏õ‡∏£‡∏î‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå';
                    analysisTextEl.textContent = '';
                    let i = 0;
                    typingInterval = setInterval(() => {
                        if (i < content.length) {
                             analysisTextEl.textContent += content.charAt(i);
                             i++;
                        } else {
                            clearInterval(typingInterval);
                        }
                    }, 25);
                } else {
                    toggleAnalysisBtn.innerHTML = `&gt; ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå`;
                }
            }
            
            const emergencyMapEl = document.getElementById('map-emergency');
            const findBtn = document.getElementById('find-location-btn');
            const testLocationBtn = document.getElementById('test-location-btn');
            const resetEmergencyBtn = document.getElementById('reset-emergency-btn');
            const statusEl = document.getElementById('emergency-status');
            const emergencyCaseSelect = document.getElementById('emergency-case');
            const resultsPanelEmergency = document.getElementById('emergency-results-panel');
            const resultsContentEmergency = document.getElementById('emergency-results-content');
            const emergencyIntermediateSection = document.getElementById('emergency-intermediate-section');
            const emergencyIntermediateList = document.getElementById('emergency-intermediate-list');
            let emergencyMap, userMarker, emergencyRoutingControl;
            let isEmergencyInitialized = false;

            const redIcon = L.icon({
                iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI0NDMDAwMCIgd2lkdGg9IjM2cHgiIGhlaWdodD0iMzZweCI+PHBhdGggZD0iTTEyIDJDOC4xMyAyIDUgNS4xMyA1IDljMCA1LjI1IDcgMTMgNyAxMyA3LTcuNzUgNy0xMyA3LTlTMTUuODcgMiAxMiAyem0wIDEyLjVjLTEuOTMgMC0zLjUtMS41Ny0zLjUtMy41UzEwLjA3IDYgMTIgNiBzMy41IDEuNTcgMy41IDMuNS0xLjU3IDMuNS0zLjUgMy41eiIvPjwvc3ZnPg==',
                iconSize: [36, 36],
                iconAnchor: [18, 36],
                popupAnchor: [0, -36]
            });

            function initEmergencyApp() {
                if(isEmergencyInitialized) return;
                emergencyMap = L.map(emergencyMapEl).setView([18.7883, 98.9853], 8);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(emergencyMap);
                findBtn.addEventListener('click', findEmergencyRoute);
                testLocationBtn.addEventListener('click', testLocation);
                resetEmergencyBtn.addEventListener('click', resetEmergencyMap);
                isEmergencyInitialized = true;
            }
            
            function getEmergencyRouteTime(startLatLng, endLatLng) {
                return new Promise((resolve, reject) => {
                    const tempRouter = L.Routing.control({
                        waypoints: [startLatLng, endLatLng],
                        createMarker: () => null,
                        routeWhileDragging: false,
                        addWaypoints: false,
                        draggableWaypoints: false,
                        fitSelectedRoutes: false,
                        show: false
                    });

                    const onRouteFound = (e) => {
                        const time = e.routes[0].summary.totalTime / 60;
                        emergencyMap.removeControl(tempRouter);
                        resolve(time);
                    };

                    const onRouteError = (e) => {
                        console.error("Emergency intermediate route error:", e);
                        emergencyMap.removeControl(tempRouter);
                        reject(e.error);
                    };
                    
                    tempRouter.on('routesfound', onRouteFound);
                    tempRouter.on('routingerror', onRouteError);
                    tempRouter.addTo(emergencyMap);
                });
            }
            
            async function findEmergencyIntermediateHospitals(userLatLng, targetHospitals, mainRoute) {
                emergencyIntermediateSection.classList.remove('hidden');
                emergencyIntermediateList.innerHTML = '<li class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô...</li>';

                const routeCoordinates = mainRoute.coordinates;
                const otherHospitals = hospitalData.filter(h => 
                    !targetHospitals.some(target => target.Hospital_TH === h.Hospital_TH)
                );
                
                const candidates = otherHospitals.filter(hospital => {
                    const hospitalLatLng = L.latLng(hospital.Latitude, hospital.Longitude);
                    for (let i = 0; i < routeCoordinates.length; i += 5) { // Check every 5th coord for performance
                        if (hospitalLatLng.distanceTo(routeCoordinates[i]) < 8000) { // 8km threshold for emergency
                            return true;
                        }
                    }
                    return false;
                });

                if (candidates.length === 0) {
                    emergencyIntermediateList.innerHTML = '<li class="text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ö‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</li>';
                    return;
                }
                
                const results = [];

                // Process candidates sequentially to avoid overwhelming the routing service
                for (const candidate of candidates.slice(0, 8)) { // Limit to 8 candidates for performance
                    try {
                        const candidateLatLng = L.latLng(candidate.Latitude, candidate.Longitude);
                        const time = await getEmergencyRouteTime(userLatLng, candidateLatLng);
                        results.push({ 
                            name: candidate.Hospital_TH, 
                            time: time,
                            type: candidate.Type,
                            specialty: candidate.Specialty 
                        });
                    } catch (error) {
                        console.warn(`Could not calculate route for ${candidate.Hospital_TH}:`, error);
                    }
                }
                
                if (results.length === 0) {
                    emergencyIntermediateList.innerHTML = '<li class="text-gray-500">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ</li>';
                    return;
                }

                results.sort((a, b) => a.time - b.time);

                emergencyIntermediateList.innerHTML = results.map(r => 
                    `<li class="border-b border-gray-200 pb-2 mb-2">
                        <div class="font-medium text-gray-800">${r.name}</div>
                        <div class="text-sm text-gray-600">‡πÄ‡∏ß‡∏•‡∏≤: ${formatTime(r.time)} ‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏∏‡∏ì</div>
                        <div class="text-xs text-gray-500">${r.type}${r.specialty ? ` ‚Ä¢ ${r.specialty}` : ''}</div>
                    </li>`
                ).join('');
            }
            
            function testLocation() {
                statusEl.innerHTML = "<span class='text-blue-600'>üß™ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö Geolocation...</span>";
                
                // Check if geolocation is supported
                if (!navigator.geolocation) {
                    statusEl.innerHTML = "<span class='text-red-600 font-semibold'>‚ùå ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation</span>";
                    return;
                }
                
                statusEl.innerHTML = "<span class='text-green-600'>‚úÖ Geolocation ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...</span>";
                
                const options = {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                };
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        
                        statusEl.innerHTML = `<span class='text-green-600 font-semibold'>‚úÖ ‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á!</span><br>
                                            <span class='text-xs text-gray-600'>Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}<br>
                                            ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: ${accuracy.toFixed(0)} ‡πÄ‡∏°‡∏ï‡∏£</span>`;
                        
                        // Show location on map
                        if(userMarker) emergencyMap.removeLayer(userMarker);
                        userMarker = L.marker([lat, lng], { icon: redIcon })
                            .addTo(emergencyMap)
                            .bindPopup(`‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: ${accuracy.toFixed(0)}m`)
                            .openPopup();
                        emergencyMap.setView([lat, lng], 13);
                    },
                    error => {
                        let errorMessage = '';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "‚ùå ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï<br><span class='text-xs'>‡πÇ‡∏õ‡∏£‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å 'Allow' ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Browser ‡∏ñ‡∏≤‡∏°</span>";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ<br><span class='text-xs'>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GPS/Location Service</span>";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "‚ùå ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤<br><span class='text-xs'>‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>";
                                break;
                            default:
                                errorMessage = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î<br><span class='text-xs'>Code: " + error.code + "</span>";
                                break;
                        }
                        statusEl.innerHTML = `<span class='text-red-600 font-semibold'>${errorMessage}</span>`;
                        console.error('Geolocation Test Error:', error);
                    },
                    options
                );
            }
            
            function resetEmergencyMap() {
                if(userMarker) {
                    emergencyMap.removeLayer(userMarker);
                    userMarker = null;
                }
                if(emergencyRoutingControl) {
                    emergencyMap.removeControl(emergencyRoutingControl);
                    emergencyRoutingControl = null;
                }
                resultsPanelEmergency.classList.add('hidden');
                emergencyIntermediateSection.classList.add('hidden');
                resultsContentEmergency.innerHTML = '';
                emergencyIntermediateList.innerHTML = '';
                statusEl.innerHTML = '';
                emergencyMap.setView([18.7883, 98.9853], 8);
                emergencyCaseSelect.value = 'general';
            }
            
            function findEmergencyRoute() {
                statusEl.innerHTML = "<span class='text-blue-600'>üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...</span>";
                if(userMarker) emergencyMap.removeLayer(userMarker);
                if(emergencyRoutingControl) emergencyMap.removeControl(emergencyRoutingControl);
                resultsPanelEmergency.classList.add('hidden');
                
                // Check if geolocation is supported
                if (!navigator.geolocation) {
                    statusEl.innerHTML = "<span class='text-red-600 font-semibold'>‚ùå ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation</span>";
                    return;
                }
                
                // Check if using HTTPS (required for geolocation in many browsers)
                if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    statusEl.innerHTML = `
                        <span class='text-orange-600 font-semibold'>‚ö†Ô∏è ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ HTTPS</span><br>
                        <span class='text-xs text-gray-600'>Geolocation ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô HTTP ‡∏ö‡∏≤‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå</span>
                    `;
                }
                
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                };
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        statusEl.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô...";
                        const userLatLng = L.latLng(position.coords.latitude, position.coords.longitude);
                        
                        if (userMarker) emergencyMap.removeLayer(userMarker);
                        userMarker = L.marker(userLatLng, { icon: redIcon }).addTo(emergencyMap).bindPopup("‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì").openPopup();
                        emergencyMap.setView(userLatLng, 13);
                        
                        const selectedCase = emergencyCaseSelect.value;
                        let candidateHospitals = [];

                        // Filter hospitals based on emergency case
                        if (selectedCase === 'stroke') {
                            candidateHospitals = hospitalData.filter(h => h.Specialty && 
                                (h.Specialty.toLowerCase().includes('‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á') || 
                                 h.Specialty.toLowerCase().includes('stroke')));
                        } else if (selectedCase === 'heart') {
                            candidateHospitals = hospitalData.filter(h => h.Specialty && 
                                (h.Specialty.toLowerCase().includes('‡∏´‡∏±‡∏ß‡πÉ‡∏à') || 
                                 h.Specialty.toLowerCase().includes('heart')));
                        } else if (selectedCase === 'er-icu') {
                            candidateHospitals = hospitalData.filter(h => h.Specialty && 
                                (h.Specialty.toLowerCase().includes('er') || 
                                 h.Specialty.toLowerCase().includes('icu')));
                        } else if (selectedCase === 'trauma') {
                            // For trauma cases, prioritize university hospitals, general/central hospitals, and large private hospitals
                            candidateHospitals = hospitalData.filter(h => 
                                h.Type === "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç" || 
                                h.Type === "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ/‡∏®‡∏π‡∏ô‡∏¢‡πå" || 
                                h.Type === "‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà");
                        } else { 
                            candidateHospitals = hospitalData;
                        }
                        
                        if (candidateHospitals.length === 0) {
                            statusEl.innerHTML = "‡πÑ‡∏°‡πà‡∏û‡∏ö ‡∏£‡∏û. ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö <br> <span class='text-xs text-orange-600'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏£‡∏û. ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÅ‡∏ó‡∏ô...</span>";
                            candidateHospitals = hospitalData;
                        } else {
                            statusEl.innerHTML = `‡∏û‡∏ö‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ${candidateHospitals.length} ‡πÅ‡∏´‡πà‡∏á <br> <span class='text-xs text-green-600'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°...</span>`;
                        }

                        const highCapabilityTypes = ["‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ/‡∏®‡∏π‡∏ô‡∏¢‡πå", "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç", "‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà"];
                        
                        let hospitalsWithDistance = candidateHospitals.map(h => ({
                            ...h,
                            distance: userLatLng.distanceTo([h.Latitude, h.Longitude])
                        }));

                        hospitalsWithDistance.sort((a, b) => a.distance - b.distance);

                        const nearestFirstStop = hospitalsWithDistance[0];
                        const ultimateDestination = hospitalsWithDistance.find(h => highCapabilityTypes.includes(h.Type) && h.Hospital_TH !== nearestFirstStop.Hospital_TH) || nearestFirstStop;

                        let waypoints = [
                            { latLng: userLatLng, name: "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" }
                        ];

                        if (nearestFirstStop && ultimateDestination && nearestFirstStop.Hospital_TH !== ultimateDestination.Hospital_TH) {
                            waypoints.push({ latLng: L.latLng(nearestFirstStop.Latitude, nearestFirstStop.Longitude), name: nearestFirstStop.Hospital_TH });
                        }
                        if(ultimateDestination) {
                           waypoints.push({ latLng: L.latLng(ultimateDestination.Latitude, ultimateDestination.Longitude), name: ultimateDestination.Hospital_TH });
                        }
                        
                        if (waypoints.length > 1) {
                             displayMultiStopEmergencyRoute(waypoints);
                             setTimeout(() => {
                                 statusEl.innerHTML = `<span class='text-green-600 font-semibold'>‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>`;
                             }, 1000);
                        } else {
                            statusEl.innerHTML = `<span class='text-red-600 font-semibold'>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ</span>`;
                        }

                    },
                    error => {
                        let errorMessage = '';
                        let helpText = '';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
                                helpText = "‡πÇ‡∏õ‡∏£‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å 'Allow' ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Browser ‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ";
                                helpText = "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GPS, Location Service ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
                                helpText = "‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏•‡πà‡∏á";
                                break;
                            default:
                                errorMessage = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
                                helpText = `Error Code: ${error.code} - ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
                                break;
                        }
                        statusEl.innerHTML = `
                            <span class='text-red-600 font-semibold'>‚ùå ${errorMessage}</span><br>
                            <span class='text-xs text-gray-600'>${helpText}</span><br>
                            <span class='text-xs text-blue-600 cursor-pointer underline' onclick='document.getElementById("test-location-btn").click()'>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>
                        `;
                        console.error('Geolocation Error:', error.message, error);
                    },
                    options
                );
            }

            function displayMultiStopEmergencyRoute(waypoints) {
                if (emergencyRoutingControl) emergencyMap.removeControl(emergencyRoutingControl);
                
                // Reset intermediate section
                emergencyIntermediateSection.classList.add('hidden');
                emergencyIntermediateList.innerHTML = '';

                const distinctWaypoints = waypoints.filter((waypoint, index, self) =>
                    index === self.findIndex((w) => (
                        w.latLng.equals(waypoint.latLng)
                    ))
                );

                if (distinctWaypoints.length < 2) {
                    statusEl.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ (‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô)";
                    return;
                }

                emergencyRoutingControl = L.Routing.control({ 
                    waypoints: distinctWaypoints.map(wp => wp.latLng)
                }).addTo(emergencyMap);

                emergencyRoutingControl.on('routesfound', e => {
                    const route = e.routes[0];
                    const selectedCase = emergencyCaseSelect.value;
                    let caseDisplayName = '';
                    
                    switch(selectedCase) {
                        case 'stroke': caseDisplayName = '‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á (Stroke)'; break;
                        case 'heart': caseDisplayName = '‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à'; break;
                        case 'er-icu': caseDisplayName = '‡∏´‡πâ‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô/‡πÑ‡∏≠‡∏ã‡∏µ‡∏¢‡∏π'; break;
                        case 'trauma': caseDisplayName = '‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á/‡πÄ‡∏ó‡∏£‡∏≤‡∏°‡∏≤'; break;
                        default: caseDisplayName = '‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏/‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'; break;
                    }
                    
                    resultsContentEmergency.innerHTML = `
                        <div class="bg-red-100 border border-red-300 p-3 rounded-lg mb-4">
                            <h3 class="font-bold text-red-800">‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô: ${caseDisplayName}</h3>
                            <p class="text-sm text-red-700">‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</p>
                        </div>
                    `;
                    
                    let totalTime = 0;
                    let totalDistance = 0;

                    route.legs.forEach((leg, index) => {
                        const from = distinctWaypoints[index].name;
                        const to = distinctWaypoints[index + 1].name;
                        const time = leg.summary.totalTime / 60;
                        const distance = leg.summary.totalDistance / 1000;
                        
                        totalTime += time;
                        totalDistance += distance;
                        
                        // Find hospital info for better display
                        const toHospital = hospitalData.find(h => h.Hospital_TH === to);
                        const hospitalInfo = toHospital ? `
                            <div class="text-xs text-gray-600 mt-1">
                                <p>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${toHospital.Type}</p>
                                ${toHospital.Specialty ? `<p>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç: ${toHospital.Specialty}</p>` : ''}
                            </div>
                        ` : '';
                        
                        const legHtml = `
                            <div class="bg-red-50 border-l-4 border-red-500 p-3 rounded-r-lg mb-3 emergency-card">
                                <div class="flex items-center space-x-2 mb-2">
                                    <div class="bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">${index + 1}</div>
                                    <p class="font-semibold text-gray-800">${from} ‚Üí ${to}</p>
                                </div>
                                ${hospitalInfo}
                                <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
                                    <div class="bg-white p-2 rounded">
                                        <p class="text-gray-600">‡πÄ‡∏ß‡∏•‡∏≤</p>
                                        <p class="font-bold text-red-600">${formatTime(time)}</p>
                                    </div>
                                    <div class="bg-white p-2 rounded">
                                        <p class="text-gray-600">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á</p>
                                        <p class="font-bold text-red-600">${distance.toFixed(2)} ‡∏Å‡∏°.</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        resultsContentEmergency.innerHTML += legHtml;
                    });

                    const summaryHtml = `
                        <div class="bg-gray-800 text-white p-4 rounded-lg mt-4">
                            <h3 class="font-bold text-lg mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 2L3 7v11a1 1 0 001 1h5v-6h2v6h5a1 1 0 001-1V7l-7-5z" clip-rule="evenodd"/>
                                </svg>
                                ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
                            </h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-700 p-3 rounded">
                                    <p class="text-gray-300 text-sm">‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°</p>
                                    <p class="font-bold text-xl text-red-400">${formatTime(totalTime)}</p>
                                </div>
                                <div class="bg-gray-700 p-3 rounded">
                                    <p class="text-gray-300 text-sm">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°</p>
                                    <p class="font-bold text-xl text-red-400">${totalDistance.toFixed(2)} ‡∏Å‡∏°.</p>
                                </div>
                            </div>
                            <div class="mt-3 p-3 bg-red-600 rounded text-center">
                                <p class="text-sm font-semibold">üö® ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ç‡∏±‡∏ö‡∏Ç‡∏µ‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÅ‡∏•‡∏∞‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏à‡∏£‡∏≤‡∏à‡∏£</p>
                            </div>
                        </div>
                    `;
                    resultsContentEmergency.innerHTML += summaryHtml;

                    resultsPanelEmergency.classList.remove('hidden');
                    
                    // Set map bounds to show the route properly
                    const bounds = L.latLngBounds(distinctWaypoints.map(wp => wp.latLng));
                    emergencyMap.fitBounds(bounds, { padding: [50, 50] });
                    
                    // Find intermediate hospitals after main route is calculated
                    const targetHospitals = distinctWaypoints.slice(1).map(wp => 
                        hospitalData.find(h => h.Hospital_TH === wp.name)
                    ).filter(h => h);
                    
                    if (targetHospitals.length > 0) {
                        const userLatLng = distinctWaypoints[0].latLng;
                        findEmergencyIntermediateHospitals(userLatLng, targetHospitals, route);
                    }
                });
            }
        });
    </script>
</body>
</html>

