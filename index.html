<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ER Route Finder: ระบบค้นหาเส้นทางส่งต่อผู้ป่วยฉุกเฉิน</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            --ambulance-red: #d90429;
            --ambulance-blue: #0077b6;
            --dark-blue: #023e8a;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
        }
        .leaflet-container {
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .pulse-btn {
            box-shadow: 0 0 0 0 rgba(217, 4, 41, 0.7);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(217, 4, 41, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(217, 4, 41, 0); }
            100% { box-shadow: 0 0 0 0 rgba(217, 4, 41, 0); }
        }
        .leaflet-popup-content-wrapper {
            background: var(--dark-blue);
            color: white;
            border-radius: 8px;
        }
        .leaflet-popup-content {
            font-size: 14px;
            font-weight: 500;
        }
        .leaflet-popup-tip {
            background: var(--dark-blue);
        }
    </style>
</head>
<body class="bg-light-gray">

    <!-- 
      Responsive Main Container:
      - flex-col: Default layout for mobile (vertical stack).
      - md:flex-row: Switches to a horizontal layout on tablets (768px) and larger screens.
    -->
    <div class="min-h-screen flex flex-col md:flex-row">
        <!-- 
          Responsive Control Panel:
          - w-full: Takes full width on mobile.
          - md:w-1/3 lg:w-1/4: Takes a fraction of the width on tablets and desktops.
          - md:max-h-screen: Prevents the panel from being taller than the screen on wider layouts, enabling internal scrolling.
        -->
        <div class="w-full md:w-1/3 lg:w-1/4 p-4 bg-white shadow-lg overflow-y-auto md:max-h-screen">
            <header class="text-center p-4 border-b-4 border-ambulance-red">
                <div class="flex justify-center items-center gap-3">
                    <svg class="w-12 h-12 text-ambulance-red" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
                    </svg>
                    <div>
                        <h1 class="text-2xl font-extrabold text-dark-blue">ER Route Finder</h1>
                        <p class="text-sm text-gray-500">แม่ฮ่องสอน - เชียงใหม่</p>
                    </div>
                </div>
            </header>

            <div class="space-y-6 mt-6">
                <!-- Case Selection -->
                <div class="p-4 bg-medium-gray rounded-xl">
                    <label for="case-selector" class="block text-lg font-bold text-dark-blue mb-2">1. เลือกสถานการณ์ฉุกเฉิน</label>
                    <select id="case-selector" class="w-full p-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-ambulance-blue focus:border-ambulance-blue">
                        <option value="stroke">ภาวะหลอดเลือดสมอง (Stroke)</option>
                        <option value="heart">ภาวะหัวใจขาดเลือด (STEMI)</option>
                        <option value="trauma">อุบัติเหตุรุนแรง (Trauma)</option>
                        <option value="all">แสดงโรงพยาบาลทั้งหมด</option>
                    </select>
                </div>

                <!-- Action Panel -->
                <div class="p-4 bg-medium-gray rounded-xl">
                    <h2 class="text-lg font-bold text-dark-blue mb-3">2. เลือกการดำเนินการ</h2>
                    
                    <div class="space-y-3">
                        <p class="font-semibold text-gray-700">A) ค้นหาเส้นทางระหว่างโรงพยาบาล</p>
                        <select id="path-start" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ambulance-blue"></select>
                        <div class="text-center font-bold text-gray-500">ถึง</div>
                        <select id="path-end" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ambulance-blue"></select>
                        <button id="find-path-btn" class="w-full bg-ambulance-blue text-white font-bold py-3 px-4 rounded-lg hover:bg-dark-blue transition-all duration-300 flex items-center justify-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                             </svg>
                            ค้นหาเส้นทาง
                        </button>
                    </div>

                    <div class="my-4 border-t border-gray-300"></div>
                    
                    <div>
                        <p class="font-semibold text-gray-700 mb-3">B) ค้นหา รพ. ที่ใกล้ที่สุดจากจุดเกิดเหตุ</p>
                        <button id="find-nearest-btn" class="w-full bg-ambulance-red text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-all duration-300 flex items-center justify-center gap-2 pulse-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                            </svg>
                            ปักหมุดจุดเกิดเหตุ
                        </button>
                        <p id="pin-mode-status" class="text-center text-sm text-ambulance-red mt-2 h-4"></p>
                    </div>
                </div>
                
                 <div id="result-card" class="p-4 bg-white rounded-xl border-2 border-dark-blue min-h-[150px]">
                    <h2 class="text-lg font-bold text-dark-blue mb-2">สรุปผลการค้นหา</h2>
                    <div id="result-text" class="text-gray-700 space-y-2">
                        <p>กรุณาเลือกการดำเนินการ</p>
                    </div>
                </div>

            </div>
        </div>

        <!-- Display Area -->
        <div class="flex-1 flex flex-col p-4 gap-4">
            <!-- View Toggler -->
            <div class="flex justify-center bg-medium-gray p-1 rounded-xl shadow-sm">
                <button id="show-map-btn" class="flex-1 py-2 px-4 rounded-lg font-bold">แผนที่จริง</button>
                <button id="show-graph-btn" class="flex-1 py-2 px-4 rounded-lg font-bold">Graph Model</button>
            </div>

            <!-- Graph Theory View Container -->
            <div id="graph-view" class="bg-white rounded-2xl p-4 flex-1 flex-col hidden min-h-[40vh] md:min-h-0">
                <h2 class="text-xl font-bold text-dark-blue mb-3 text-center">แบบจำลองเครือข่าย (Graph Model)</h2>
                <div class="flex-1 w-full relative">
                     <canvas id="network-canvas" class="w-full h-full"></canvas>
                </div>
            </div>

            <!-- Real Map View Container -->
            <div id="map-view" class="bg-white rounded-2xl p-4 flex-1 flex-col min-h-[50vh] md:min-h-0">
                <h2 class="text-xl font-bold text-dark-blue mb-3 text-center">แผนที่เส้นทางจริง (Real Map)</h2>
                <div id="map" class="flex-1 w-full rounded-xl"></div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- GLOBAL STATE ---
    let nodes = [];
    let edges = [];
    let shortestPath = { nodes: [], totalWeight: 0 };
    let currentSpecialty = 'stroke';
    let isPinMode = false;
    let patientMarker = null;

    // --- DOM ELEMENTS ---
    const canvas = document.getElementById('network-canvas');
    const ctx = canvas.getContext('2d');
    const caseSelector = document.getElementById('case-selector');
    const pathStartSelect = document.getElementById('path-start');
    const pathEndSelect = document.getElementById('path-end');
    const findPathBtn = document.getElementById('find-path-btn');
    const findNearestBtn = document.getElementById('find-nearest-btn');
    const pinModeStatus = document.getElementById('pin-mode-status');
    const resultText = document.getElementById('result-text');
    const showMapBtn = document.getElementById('show-map-btn');
    const showGraphBtn = document.getElementById('show-graph-btn');
    const mapView = document.getElementById('map-view');
    const graphView = document.getElementById('graph-view');

    // --- MAP INITIALIZATION ---
    const map = L.map('map').setView([18.7883, 98.9853], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    let routePolyline = null;
    const hospitalMarkers = L.layerGroup().addTo(map);

    // --- ICONS ---
    const specialtyIcons = {
        'heart': L.icon({ iconUrl: 'https://img.icons8.com/plasticine/100/heart-with-pulse.png', iconSize: [40, 40] }),
        'stroke': L.icon({ iconUrl: 'https://img.icons8.com/plasticine/100/brain.png', iconSize: [40, 40] }),
        'trauma': L.icon({ iconUrl: 'https://img.icons8.com/plasticine/100/hospital-bed.png', iconSize: [40, 40] }),
        'junction': L.icon({ iconUrl: 'https://img.icons8.com/plasticine/100/waypoint-map.png', iconSize: [30, 30] }),
        'default': L.icon({ iconUrl: 'https://img.icons8.com/plasticine/100/hospital.png', iconSize: [35, 35] })
    };
    const patientIcon = L.icon({ iconUrl: 'https://img.icons8.com/plasticine/100/ambulance.png', iconSize: [50, 50] });

    // --- DATA ---
    const ALL_DATA = {
        nodes: [
            { id: 0, name: 'รพ.ศรีสังวาลย์', x: 100, y: 250, lat: 19.292, lon: 97.971, specialties: ['trauma', 'general'] },
            { id: 1, name: 'รพ.ปาย', x: 300, y: 150, lat: 19.362, lon: 98.439, specialties: ['general'] },
            { id: 2, name: 'รพ.แม่สะเรียง', x: 150, y: 500, lat: 18.156, lon: 97.933, specialties: ['general'] },
            { id: 3, name: 'แยกแม่มาลัย', x: 500, y: 250, lat: 18.995, lon: 98.857, specialties: ['junction'] },
            { id: 4, name: 'รพ.นครพิงค์', x: 600, y: 180, lat: 18.854, lon: 98.966, specialties: ['heart', 'trauma'] },
            { id: 5, name: 'รพ.มหาราชนครเชียงใหม่', x: 620, y: 320, lat: 18.788, lon: 98.975, specialties: ['heart', 'stroke', 'trauma'] },
            { id: 6, name: 'รพ.เชียงใหม่ราม', x: 580, y: 280, lat: 18.796, lon: 98.973, specialties: ['heart', 'stroke'] },
            { id: 7, name: 'รพ.กรุงเทพเชียงใหม่', x: 680, y: 380, lat: 18.775, lon: 99.018, specialties: ['heart', 'stroke'] },
            { id: 8, name: 'รพ.ลานนา', x: 650, y: 220, lat: 18.811, lon: 99.004, specialties: ['trauma'] },
        ],
        edges: [
            { from: 0, to: 1, weight: 150 }, { from: 1, to: 3, weight: 120 },
            { from: 3, to: 4, weight: 35 }, { from: 3, to: 6, weight: 40 },
            { from: 3, to: 8, weight: 30 }, { from: 4, to: 8, weight: 15 },
            { from: 6, to: 5, weight: 10 }, { from: 5, to: 7, weight: 15 },
            { from: 0, to: 2, weight: 180 },
        ]
    };
    
    // --- CORE LOGIC ---
    function setupForSpecialty(specialty) {
        currentSpecialty = specialty;
        shortestPath = { nodes: [], totalWeight: 0 };
        
        if (specialty === 'all') {
            nodes = ALL_DATA.nodes.filter(n => !n.specialties.includes('junction'));
        } else {
            nodes = ALL_DATA.nodes.filter(n => n.specialties.includes(specialty) || n.specialties.includes('general') || n.specialties.includes('junction'));
        }
        edges = ALL_DATA.edges;

        updateDropdowns();
        drawAll();
        clearResult();
    }

    function updateDropdowns() {
        const hospitalNodes = ALL_DATA.nodes.filter(n => !n.specialties.includes('junction'));
        const options = hospitalNodes.map(node => `<option value="${node.id}">${node.name}</option>`).join('');
        pathStartSelect.innerHTML = options;
        pathEndSelect.innerHTML = options;
    }
    
    function dijkstra(graphNodes, graphEdges, startNodeId) {
        const distances = {}; const prev = {}; const pq = new Set();
        graphNodes.forEach(node => {
            distances[node.id] = Infinity; prev[node.id] = null; pq.add(node.id);
        });
        distances[startNodeId] = 0;
        while (pq.size > 0) {
            let u = [...pq].reduce((minNode, node) => distances[node] < distances[minNode] ? node : minNode, [...pq][0]);
            pq.delete(u);
            const neighbors = graphEdges.filter(e => e.from === u || e.to === u);
            for (const edge of neighbors) {
                const v = edge.from === u ? edge.to : edge.from;
                if (pq.has(v)) {
                    const alt = distances[u] + edge.weight;
                    if (alt < distances[v]) { distances[v] = alt; prev[v] = u; }
                }
            }
        }
        return { distances, prev };
    }
    
    function findShortestPath(startId, endId) {
        const { distances, prev } = dijkstra(ALL_DATA.nodes, ALL_DATA.edges, startId);
        const path = []; let current = endId;
        if (prev[current] !== null || current === startId) {
            while (current !== undefined && current !== null) { path.unshift(current); current = prev[current]; }
        }
        if (path.length > 0 && path[0] === startId) { return { nodes: path, totalWeight: distances[endId] }; }
        return { nodes: [], totalWeight: Infinity };
    }

    // --- DRAWING & UI ---
    function drawAll() {
        drawGraph();
        drawMapMarkers();
        drawMapRoute();
    }
    
    function drawGraph() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        edges.forEach(edge => {
            const fromNode = ALL_DATA.nodes.find(n => n.id === edge.from);
            const toNode = ALL_DATA.nodes.find(n => n.id === edge.to);
            if (!fromNode || !toNode) return;
            const isPathEdge = shortestPath.nodes.includes(fromNode.id) && shortestPath.nodes.includes(toNode.id);
            const fromIndex = shortestPath.nodes.indexOf(fromNode.id);
            const toIndex = shortestPath.nodes.indexOf(toNode.id);
            const isSequential = Math.abs(fromIndex - toIndex) === 1;
            ctx.beginPath();
            ctx.moveTo(fromNode.x, fromNode.y);
            ctx.lineTo(toNode.x, toNode.y);
            ctx.strokeStyle = (isPathEdge && isSequential) ? 'var(--ambulance-red)' : '#adb5bd';
            ctx.lineWidth = (isPathEdge && isSequential) ? 4 : 2;
            ctx.stroke();
            const midX = (fromNode.x + toNode.x) / 2;
            const midY = (fromNode.y + toNode.y) / 2;
            ctx.fillStyle = (isPathEdge && isSequential) ? 'var(--ambulance-red)' : '#495057';
            ctx.font = '14px Sarabun';
            ctx.fillText(edge.weight, midX + 5, midY - 5);
        });
        const visibleNodes = ALL_DATA.nodes.filter(n => nodes.some(vn => vn.id === n.id));
        visibleNodes.forEach(node => {
            const isStart = shortestPath.nodes.length > 0 && node.id === shortestPath.nodes[0];
            const isEnd = shortestPath.nodes.length > 0 && node.id === shortestPath.nodes[shortestPath.nodes.length - 1];
            ctx.beginPath();
            ctx.arc(node.x, node.y, isStart || isEnd ? 12 : 8, 0, 2 * Math.PI);
            ctx.fillStyle = isStart ? 'var(--ambulance-blue)' : isEnd ? 'var(--ambulance-red)' : '#6c757d';
            if (node.specialties.includes(currentSpecialty) && !node.specialties.includes('junction')) ctx.fillStyle = 'var(--ambulance-red)';
            ctx.fill();
            ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke();
            ctx.fillStyle = '#212529'; ctx.font = 'bold 16px Sarabun';
            ctx.fillText(node.name, node.x + 15, node.y + 5);
        });
    }

    function resizeCanvas() {
        const rect = canvas.parentElement.getBoundingClientRect();
        if (canvas.width !== rect.width || canvas.height !== rect.height) {
            canvas.width = rect.width; canvas.height = rect.height;
            drawGraph();
        }
    }

    function drawMapMarkers() {
        hospitalMarkers.clearLayers();
        nodes.forEach(node => {
            if(node.specialties.includes('junction')) return;
            const isSpecialist = node.specialties.includes(currentSpecialty);
            let icon = specialtyIcons.default;
            if (isSpecialist && specialtyIcons[currentSpecialty]) icon = specialtyIcons[currentSpecialty];
            const marker = L.marker([node.lat, node.lon], { icon }).addTo(hospitalMarkers);
            marker.bindPopup(`<b>${node.name}</b><br>${isSpecialist ? `เชี่ยวชาญด้าน ${currentSpecialty}` : 'รพ.ทั่วไป/ชุมชน'}`);
        });
    }

    function drawMapRoute() {
        if (routePolyline) map.removeLayer(routePolyline);
        if (shortestPath.nodes.length > 1) {
            const latlngs = shortestPath.nodes.map(id => {
                if (id === 999) return [patientMarker.getLatLng().lat, patientMarker.getLatLng().lng];
                const node = ALL_DATA.nodes.find(n => n.id === id);
                return node ? [node.lat, node.lon] : null;
            }).filter(Boolean);
            if (latlngs.length > 1) {
                 routePolyline = L.polyline(latlngs, { color: 'var(--ambulance-red)', weight: 5 }).addTo(map);
                 map.fitBounds(routePolyline.getBounds().pad(0.2));
            }
        }
    }

    function displayResult(path, startNodeName = null, endNodeName = null) {
        if (path.nodes.length > 1 && path.totalWeight !== Infinity) {
            const pathNames = path.nodes.map(id => {
                if (id === 999) return 'จุดเกิดเหตุ';
                return ALL_DATA.nodes.find(n => n.id === id)?.name || 'Unknown';
            });
            const hours = Math.floor(path.totalWeight / 60);
            const minutes = path.totalWeight % 60;
            const timeString = `${hours > 0 ? hours + ' ชั่วโมง ' : ''}${minutes} นาที`;
            resultText.innerHTML = `
                <div class="flex items-center gap-2 flex-wrap">
                     <span class="font-bold text-ambulance-blue">${startNodeName || pathNames[0]}</span>
                     <span>→</span>
                     <span class="font-bold text-ambulance-red">${endNodeName || pathNames[pathNames.length-1]}</span>
                </div>
                <p class="font-bold text-xl my-2">ใช้เวลาประมาณ: <span class="text-dark-blue">${timeString}</span></p>
                <p class="text-sm">เส้นทาง: ${pathNames.join(' → ')}</p>
            `;
        } else {
            resultText.innerHTML = `<p class="text-ambulance-red font-bold">ไม่พบเส้นทางที่สามารถเชื่อมต่อได้</p>`;
        }
    }
    
    function clearResult(){
        resultText.innerHTML = '<p>กรุณาเลือกการดำเนินการ</p>';
        if (routePolyline) map.removeLayer(routePolyline);
        if(patientMarker) map.removeLayer(patientMarker);
        patientMarker = null;
    }

    const activeBtnClass = 'bg-dark-blue text-white shadow';
    const inactiveBtnClass = 'bg-transparent text-gray-600';

    function switchView(view) {
        if (view === 'map') {
            mapView.classList.remove('hidden'); mapView.classList.add('flex');
            graphView.classList.add('hidden'); graphView.classList.remove('flex');
            showMapBtn.className = `flex-1 py-2 px-4 rounded-lg font-bold transition-all ${activeBtnClass}`;
            showGraphBtn.className = `flex-1 py-2 px-4 rounded-lg font-bold transition-all ${inactiveBtnClass}`;
            setTimeout(() => map.invalidateSize(), 100);
        } else {
            graphView.classList.remove('hidden'); graphView.classList.add('flex');
            mapView.classList.add('hidden'); mapView.classList.remove('flex');
            showGraphBtn.className = `flex-1 py-2 px-4 rounded-lg font-bold transition-all ${activeBtnClass}`;
            showMapBtn.className = `flex-1 py-2 px-4 rounded-lg font-bold transition-all ${inactiveBtnClass}`;
            resizeCanvas();
        }
    }

    // --- EVENT LISTENERS ---
    caseSelector.addEventListener('change', (e) => setupForSpecialty(e.target.value));
    findPathBtn.addEventListener('click', () => {
        const startId = parseInt(pathStartSelect.value);
        const endId = parseInt(pathEndSelect.value);
        if (startId === endId) {
            shortestPath = { nodes: [], totalWeight: 0 };
            resultText.innerHTML = `<p class="text-ambulance-red font-bold">กรุณาเลือกโรงพยาบาลเริ่มต้นและปลายทางที่แตกต่างกัน</p>`;
            drawAll(); return;
        }
        shortestPath = findShortestPath(startId, endId);
        displayResult(shortestPath);
        drawAll();
    });
    findNearestBtn.addEventListener('click', () => {
        isPinMode = !isPinMode;
        pinModeStatus.textContent = isPinMode ? 'คลิกบนแผนที่เพื่อระบุจุดเกิดเหตุ' : '';
        if(isPinMode) findNearestBtn.classList.remove('pulse-btn');
        map.getContainer().style.cursor = isPinMode ? 'crosshair' : '';
        if(isPinMode) switchView('map');
    });
    map.on('click', (e) => {
        if (!isPinMode) return;
        if(patientMarker) map.removeLayer(patientMarker);
        patientMarker = L.marker(e.latlng, { icon: patientIcon }).addTo(map);

        const targetNodes = ALL_DATA.nodes.filter(n => n.specialties.includes(currentSpecialty));
        if (targetNodes.length === 0) {
            resultText.innerHTML = `<p class="text-ambulance-red font-bold">ไม่พบโรงพยาบาลที่เชี่ยวชาญด้านนี้</p>`; return;
        }
        let closestGraphNode = null; let minDistance = Infinity;
        ALL_DATA.nodes.forEach(node => {
            const d = map.distance(e.latlng, [node.lat, node.lon]);
            if (d < minDistance) { minDistance = d; closestGraphNode = node; }
        });
        const timeToClosestNode = Math.round(minDistance / 1000);
        let bestPath = { nodes: [], totalWeight: Infinity }; let bestTargetNode = null;
        targetNodes.forEach(targetNode => {
            let pathFromClosest = { nodes: [], totalWeight: Infinity };
            let totalTime;
            if (closestGraphNode.id === targetNode.id) {
                totalTime = timeToClosestNode;
                pathFromClosest = { nodes: [targetNode.id], totalWeight: 0 };
            } else {
                pathFromClosest = findShortestPath(closestGraphNode.id, targetNode.id);
                totalTime = timeToClosestNode + pathFromClosest.totalWeight;
            }
            if (pathFromClosest.totalWeight !== Infinity && totalTime < bestPath.totalWeight) {
                bestPath = { nodes: [999, ...pathFromClosest.nodes], totalWeight: totalTime };
                bestTargetNode = targetNode;
            }
        });
        if (bestTargetNode) {
            shortestPath = bestPath;
            displayResult(bestPath, "จุดเกิดเหตุ", bestTargetNode.name);
            drawAll();
        } else {
            resultText.innerHTML = `<p class="text-ambulance-red font-bold">ไม่สามารถคำนวณเส้นทางได้</p>`;
        }
        isPinMode = false;
        pinModeStatus.textContent = '';
        map.getContainer().style.cursor = '';
        findNearestBtn.classList.add('pulse-btn');
    });

    showMapBtn.addEventListener('click', () => switchView('map'));
    showGraphBtn.addEventListener('click', () => switchView('graph'));

    // --- INITIALIZE ---
    new ResizeObserver(resizeCanvas).observe(canvas.parentElement);
    setupForSpecialty('stroke');
    switchView('map');
});
</script>

</body>
</html>

